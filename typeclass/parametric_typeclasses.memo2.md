# パラメトリック型クラスまとめ

オダスキー先生が若い頃92年ころにアメリカの東海岸ニューヨークから北東へ１００キロほどのイエール大学にいて型クラスの論文を書いてまして、これが構文主導の規則が乗っているので型クラスの実装例として良いのではないかと思って読んでみます。

内容としては、型クラスの型に型制約のパラメータを追加するというもので、mini-haskellにプラスした mini-haskell+ 言語を作成して型システムを作り、型付け規則を作り、その後構文主導な型付け規則を作ってという具合に良さそうなものなのであります。

  その抽象構文と型が図1です。

    Type variables     α
    Type constructors  κ
    Class constructors c
    Types              τ ::= () | κ τ | α | τ1 * τ2 | τ1 -> τ2
    Type schemes       σ ::= ∀α::Γ.σ | τ
    Type classes       γ ::= c τ
    Class sets         Γ ::= {c1 τ1,..., cn τn}       (n ≥ 0,ci pairwise disjoint)
    Contexts           C ::= {α1::Γ1, ..., αn::Γn} (n ≥ 0)

    Expressions        e ::= x | e e' | λx : e | let x = e' in e
    Programs           p ::= class α::γ where x : σ in p
                        |  inst C ⇒ τ::γ where x = e in p
                        |  e
    
  図1: Mini-Haskell+ の抽象構文

こんな言語です。
この言語の特徴は `class α::γ where x : σ in p`の αがつくてんで型パラメータを暮らす宣言につけることが出来るわけです。
加えて以下の束縛規則なるものがあります。

    C ⊦⊦ α :: γ     (α::{...γ...} ∈ C)

    C ⊦⊦ C'
    ---------    ("inst C' ⇒ τ::γ" ∈ Ds)
    C ⊦⊦ τ::γ

    C ⊦⊦ τ::γ1   ...   C ⊦⊦ τ::γn
    -----------------------------    (n ≥ 0)
    C ⊦⊦ τ:: {γ1 ,..., γn}

    C ⊦⊦ τ1::Γ1   ...   C ⊦⊦ τn::Γn
    ------------------------------------ (n ≥ 0)
    C ⊦⊦ {τ1::Γ1,  ...  ,fτn::Γn}

  図2: 束縛の推論規則

この規則はよくわからんのですけどクラスの集合と型パラメータと、
、型コンストラクタが文脈Cとなるのだけど文脈の推論はこのようにできますよというもののようです。


    (var)       A,C ⊢ x : σ    (x : σ ∈ A)

                A,C ⊢ e : ∀α::Γ.σ    C ⊦⊦ τ::Γ
    (∀-elim)   --------------------------------
                A,C ⊢ e : [α -> τ] σ

                A,C.α::Γ ⊢ e : σ
    (∀-intro)  ------------------------ (α ∉ fv A ∪ reg C)
                A,C ⊢ e : ∀α::Γ.σ
    
                A,C ⊢ e :τ' -> τ    A,C ⊢ e' : τ'
    (λ-elim)    --------------------------------
                A,C ⊢ e e' : τ

                A.x:τ',C ⊢ e : τ
    (λ-intro)   --------------------------------
                A,C ⊢ λx.e :τ' -> τ

                A,C ⊢ e' : σ    A.x : σ,C ⊢ e : τ
    (let)       --------------------------------------
                A,C ⊢ let x = e' in e : τ

  図3: 式の型付け規則

                A.x : ∀_{fvγ} ∀α :: {γ}.σ, C ⊢ p : τ
    (class)     -------------------------------------------
                A,C ⊢ class α :: γ　where x : σ in p : τ

                A,C ⊢ x : ∀α :: {γ} :σ    A,C ⊢ e :[α ->τ'] σ    A,C ⊢ p : τ
    (inst)      --------------------------------------------------------------
                A,C ⊢ inst C' ⇒ τ'::γ where x = e in p : τ

  図4: 宣言の型付け規則

図3,4は型付け規則です。図3は宣言的なので図5のように決定的に書き換えることができます：

    (var')      A,C ⊢' x : τ    (x : σ ∈ A, τ ≼C σ)

                A,C ⊢' e : τ' -> τ    A,C ⊢' e' : τ'
    (∀-elim')  ------------------------------
                A,C ⊢' e e' : τ

                A.x : τ', C ⊢' e : τ
    (∀-intro') -----------------------
                A,C ⊢' λx.e : τ' -> τ
    
                A,C ⊢' e' : τ'    A.x : σ,C ⊢' e : τ
    (let')      ---------------------------------------- (σ, C'') = gen(τ',A,C'), C'' ≼ C
                A,C ⊢' let x = e' in e : τ

  図5: 式の決定的型付け規則
